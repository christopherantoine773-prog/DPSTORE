<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPSTORE â€” Connexion / Inscription</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #000; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
    .container { width: 90%; max-width: 400px; background: rgba(20,20,20,0.95); padding: 30px; border-radius: 12px; box-shadow: 0 0 25px #f9d71c; text-align:center; border:1px solid #f9d71c; }
    h1 { color: #f9d71c; font-size: 1.8em; margin-bottom: 20px; }
    input { width:100%; padding:12px; margin:10px 0; border:none; outline:none; border-radius:6px; background:#111; color:#f9d71c; font-size:14px; border:1px solid #f9d71c; }
    button { width:100%; padding:12px; border:none; border-radius:6px; background:#f9d71c; color:#000; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#fff700; }
    .switch { color:#ccc; font-size:14px; margin-top:15px; cursor:pointer; }
    .footer { margin-top:25px; font-size:12px; color:#777; }
  </style>
</head>

<body>
  <div class="container">
    <h1>DPSTORE</h1>

    <!-- FORMULAIRE INSCRIPTION -->
    <div id="signup">
      <p>CrÃ©er ton compte</p>
      <input type="text" id="username" placeholder="Nom d'utilisateur" required />
      <input type="email" id="email" placeholder="Adresse email" required />
      <input type="password" id="password" placeholder="Mot de passe" required />
      <button onclick="sendVerificationCode()">ðŸ“§ Recevoir le code</button>

      <input type="text" id="code" placeholder="Entre le code reÃ§u" style="margin-top:15px;" />
      <button onclick="verifyCode()">âœ… VÃ©rifier le code</button>
      <p class="switch" onclick="toggleForms()">DÃ©jÃ  un compte ? Se connecter</p>
    </div>

    <!-- FORMULAIRE CONNEXION -->
    <div id="login" style="display: none;">
      <p>Connexion Ã  ton compte</p>
      <input type="email" id="loginEmail" placeholder="Adresse email" required />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required />
      <button onclick="loginUser()">ðŸš€ Se connecter</button>
      <p class="switch" onclick="toggleForms()">Pas encore inscrit ? CrÃ©er un compte</p>
    </div>
  </div>

  <p class="footer">Â© 2025 DPSTORE â€” Technologie avancÃ©e</p>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase (modular v9) loaded as module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      runTransaction,
      collection,
      addDoc,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ====== TA CONFIG FIREBASE (dÃ©jÃ  fournie) ======
    const firebaseConfig = {
      apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
      authDomain: "dpstore-officie.firebaseapp.com",
      projectId: "dpstore-officie",
      storageBucket: "dpstore-officie.firebasestorage.app",
      messagingSenderId: "903943973062",
      appId: "1:903943973062:web:6501a2ec167adb31258fc7"
    };

    // Initialisation Firebase
    let firebaseApp = null;
    let db = null;
    try {
      firebaseApp = initializeApp(firebaseConfig);
      db = getFirestore(firebaseApp);
      console.log("Firestore initialisÃ©.");
    } catch (e) {
      console.warn("Firestore non initialisÃ© (config manquante ou erreur) :", e);
    }

    // ===== EmailJS init (inchangÃ©) =====
    (function () {
      emailjs.init("5gObExmJ85l0pSXC3");
    })();

    // ========== VARIABLES EN MÃ‰MOIRE (remplacent localStorage pour pending state) ==========
    // NOTE : ces variables ne survivent pas Ã  un reload â€” c'est volontaire (plus de localStorage).
    let pendingRegistration = {
      email: null,
      username: null,
      password: null,
      verificationCode: null
    };

    // ======= Fonctions utilitaires Firestore =======
    async function getNextDPFromFirestore() {
      if (!db) throw new Error("Firestore non disponible");
      const counterRef = doc(db, "counters", "dp");
      const newNum = await runTransaction(db, async (tx) => {
        const snap = await tx.get(counterRef);
        if (!snap.exists()) {
          tx.set(counterRef, { last: 1 });
          return 1;
        } else {
          const last = snap.data().last || 0;
          const next = last + 1;
          tx.update(counterRef, { last: next });
          return next;
        }
      });
      return "DP" + String(newNum).padStart(6, "0");
    }

    // helper: save an emailjs record in Firestore
    async function recordEmailJSSent(email, code) {
      try {
        if (db) {
          await addDoc(collection(db, "emailjs_sent"), { email, code, date: new Date().toISOString() });
        }
      } catch (e) {
        console.warn("Erreur en enregistrant emailjs_sent :", e);
      }
    }

    // helper: check if a user exists by email (Firestore)
    async function userExists(email) {
      if (!db) throw new Error("Firestore non disponible");
      const safeId = encodeURIComponent(email);
      const snap = await getDoc(doc(db, "users", safeId));
      return snap.exists();
    }

    // helper: save user to Firestore (no localStorage)
    async function saveUserToFirestore(user) {
      if (!db) throw new Error("Firestore non disponible");
      const safeId = encodeURIComponent(user.email);
      const userRef = doc(db, "users", safeId);
      await setDoc(userRef, {
        username: user.username,
        email: user.email,
        password: user.password,
        role: user.role,
        credits: user.credits || 0,
        dp: user.dp,
        photo: user.photo || null,
        lastLogin: user.lastLogin || new Date().toLocaleString(),
        createdAt: user.createdAt || new Date().toISOString()
      }, { merge: true });
    }

    // helper: fetch user by email from Firestore
    async function fetchUserByEmail(email) {
      if (!db) throw new Error("Firestore non disponible");
      const safeId = encodeURIComponent(email);
      const snap = await getDoc(doc(db, "users", safeId));
      return snap.exists() ? snap.data() : null;
    }

    // ========= PrÃ©-initialisation du compte creator dans Firestore =========
    (async function initCreatorAccount() {
      try {
        const creatorEmail = "christopherantoine773@gmail.com".toLowerCase();
        if (!db) return;

        const exists = await userExists(creatorEmail);
        if (!exists) {
          const creator = {
            username: "DPSTORE",
            email: creatorEmail,
            password: "Blondy200ky444",
            role: "creator",
            credits: 0,
            dp: "DP000001",
            photo: "https://i.imgur.com/2XnKZ9R.png",
            lastLogin: new Date().toLocaleString(),
            createdAt: new Date().toISOString()
          };
          await saveUserToFirestore(creator);

          // ensure counters/dp exists and is at least 1
          const counterRef = doc(db, "counters", "dp");
          const snap = await getDoc(counterRef);
          if (!snap.exists()) {
            await setDoc(counterRef, { last: 1 });
          } else {
            const current = snap.data().last || 0;
            if (current < 1) {
              await setDoc(counterRef, { last: 1 }, { merge: true });
            }
          }
          console.log("Compte creator crÃ©Ã© dans Firestore.");
        } else {
          // ensure counters/dp at least 1
          const counterRef = doc(db, "counters", "dp");
          const snap = await getDoc(counterRef);
          if (!snap.exists()) {
            await setDoc(counterRef, { last: 1 });
          } else {
            const current = snap.data().last || 0;
            if (current < 1) {
              await setDoc(counterRef, { last: 1 }, { merge: true });
            }
          }
        }
      } catch (e) {
        console.warn("Erreur initCreatorAccount :", e);
      }
    })();

    function generateCode() { return Math.floor(100000 + Math.random() * 900000); }

    // ========= sendVerificationCode (utilise mÃ©moire + Firestore pour trace) =========
    async function sendVerificationCode() {
      const emailEl = document.getElementById("email");
      const usernameEl = document.getElementById("username");
      const passwordEl = document.getElementById("password");

      const email = emailEl.value.trim().toLowerCase();
      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (!email || !username || !password) {
        alert("âš ï¸ Remplis tous les champs !");
        return;
      }

      try {
        // check Firestore if account exists
        if (db) {
          const exists = await userExists(email);
          if (exists) {
            alert("âš ï¸ Ce compte existe dÃ©jÃ  !");
            return;
          }
        }

        const code = generateCode();
        // store pending in-memory
        pendingRegistration.email = email;
        pendingRegistration.username = username;
        pendingRegistration.password = password;
        pendingRegistration.verificationCode = String(code);

        // record emailjs attempt in Firestore
        await recordEmailJSSent(email, code);

        const params = { user_email: email, to_name: username, message: String(code) };
        emailjs.send("service_1tnwnvu", "template_7o06ag8", params)
          .then(() => alert("âœ… Code envoyÃ© !"))
          .catch(err => {
            console.warn("EmailJS erreur:", err);
            alert("âŒ Erreur : " + JSON.stringify(err));
          });
      } catch (e) {
        console.error("Erreur sendVerificationCode:", e);
        alert("âŒ Erreur lors de l'envoi du code.");
      }
    }

    function getRoleByEmail(email) {
      const CREATOR_EMAILS = ["christopherantoine773@gmail.com"];
      const EMPLOYEE_EMAILS = [
        "pilotecitizen@gmail.com",
        "ladouceurlorvynsky@gmail.com",
        "doresmaworldens@gmail.com",
        "mathieulherisson99@gmail.com"
      ];
      if (CREATOR_EMAILS.includes(email)) return "creator";
      if (EMPLOYEE_EMAILS.includes(email)) return "employee";
      return "user";
    }

    // ========= verifyCode (gÃ©nÃ¨re DP atomiquement via transaction) =========
    async function verifyCode() {
      const entered = document.getElementById("code").value.trim();

      if (!pendingRegistration.verificationCode) {
        alert("âš ï¸ Aucun code en attente (la page a peut-Ãªtre Ã©tÃ© rechargÃ©e). Re-demande le code.");
        return;
      }

      if (String(entered) === String(pendingRegistration.verificationCode)) {
        try {
          const email = pendingRegistration.email.toLowerCase();
          const username = pendingRegistration.username;
          const password = pendingRegistration.password;

          // Double-check in Firestore if account exists (race)
          if (db) {
            const exists = await userExists(email);
            if (exists) {
              alert("âš ï¸ Ce compte existe dÃ©jÃ  !");
              return;
            }
          }

          const role = getRoleByEmail(email);

          // generate DP using Firestore transaction if possible
          let dp;
          try {
            if (db) {
              dp = await getNextDPFromFirestore();
            } else {
              // as fallback create simple DP from current timestamp (shouldn't happen since db must be present)
              dp = "DP" + String(Date.now()).slice(-6);
            }
          } catch (e) {
            console.warn("Erreur transaction Firestore pour DP :", e);
            dp = "DP" + String(Date.now()).slice(-6);
          }

          const user = {
            username,
            email,
            password,
            role,
            credits: 0,
            dp,
            photo: "https://i.imgur.com/2XnKZ9R.png",
            lastLogin: new Date().toLocaleString(),
            createdAt: new Date().toISOString()
          };

          // Save to Firestore
          await saveUserToFirestore(user);

          // Set session (so profil.html peut rÃ©cupÃ©rer la session si tu utilises sessionStorage)
          try {
            sessionStorage.setItem("dpstore_user", JSON.stringify({
              email: user.email,
              username: user.username,
              dp: user.dp,
              role: user.role,
              credits: user.credits
            }));
          } catch (e) {
            console.warn("sessionStorage indisponible :", e);
          }

          alert("ðŸŽ‰ Compte crÃ©Ã© !");
          window.location.href = "profil.html";
        } catch (err) {
          console.error("Erreur verifyCode:", err);
          alert("âŒ Une erreur est survenue lors de la crÃ©ation du compte.");
        }
      } else {
        alert("âŒ Code incorrect !");
      }
    }

    // ========= loginUser (vÃ©rifie dans Firestore) =========
    async function loginUser() {
      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value.trim();

      if (!email || !password) {
        alert("âš ï¸ Remplis tous les champs !");
        return;
      }

      try {
        const user = await fetchUserByEmail(email);
        if (!user) { alert("âš ï¸ Aucun compte trouvÃ© !"); return; }
        if (user.password !== password) { alert("âŒ Mot de passe incorrect !"); return; }

        // update lastLogin in Firestore
        const safeId = encodeURIComponent(email);
        await setDoc(doc(db, "users", safeId), { lastLogin: new Date().toLocaleString() }, { merge: true });

        // set session so other pages can read the logged user
        try {
          sessionStorage.setItem("dpstore_user", JSON.stringify({
            email: user.email,
            username: user.username,
            dp: user.dp,
            role: user.role,
            credits: user.credits
          }));
        } catch (e) {
          console.warn("sessionStorage indisponible :", e);
        }

        alert("âœ… Connexion !");
        window.location.href = "profil.html";
      } catch (e) {
        console.error("Erreur loginUser:", e);
        alert("âŒ Erreur lors de la connexion.");
      }
    }

    function toggleForms() {
      const s = document.getElementById("signup");
      const l = document.getElementById("login");
      s.style.display = s.style.display === "none" ? "block" : "none";
      l.style.display = l.style.display === "none" ? "block" : "none";
    }

    // ===== Fix automatique des DP dupliquÃ©s (optionnel) =====
    // Cette fonction vÃ©rifie si plusieurs utilisateurs partagent le mÃªme dp
    // si elle trouve des doublons, elle les corrige en demandant un nouveau DP via transaction.
    // Attention : scan de la collection 'users' (opÃ©ration potentiellement lourde si bcp d'utilisateurs).
    async function fixDuplicateDPs() {
      try {
        if (!db) return;
        const q = query(collection(db, "users"));
        const snaps = await getDocs(q);
        const dpMap = new Map();
        const updates = [];
        snaps.forEach(docSnap => {
          const data = docSnap.data();
          const dp = data.dp;
          if (!dp) return;
          if (dpMap.has(dp)) {
            dpMap.get(dp).push({ id: docSnap.id, data });
          } else {
            dpMap.set(dp, [{ id: docSnap.id, data }]);
          }
        });
        for (const [dp, arr] of dpMap.entries()) {
          if (arr.length > 1) {
            // keep first, regenerate for others
            for (let i = 1; i < arr.length; i++) {
              const userId = arr[i].id;
              const newDP = await getNextDPFromFirestore();
              updates.push({ userId, newDP });
            }
          }
        }
        for (const u of updates) {
          const userRef = doc(db, "users", u.userId);
          await updateDoc(userRef, { dp: u.newDP });
        }
        if (updates.length) console.log("DP duplicatÃ©s corrigÃ©s :", updates.length);
      } catch (e) {
        console.warn("Erreur fixDuplicateDPs:", e);
      }
    }
    // On lance en arriÃ¨re-plan (silencieux)
    fixDuplicateDPs().catch(() => {});

    // expose functions on window so onclick handlers work (keeps your HTML unchanged)
    window.sendVerificationCode = sendVerificationCode;
    window.verifyCode = verifyCode;
    window.loginUser = loginUser;
    window.toggleForms = toggleForms;

  </script>
</body>
</html>
