<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPSTORE â€” Connexion / Inscription</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #000; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
    .container { width: 90%; max-width: 400px; background: rgba(20,20,20,0.95); padding: 30px; border-radius: 12px; box-shadow: 0 0 25px #f9d71c; text-align:center; border:1px solid #f9d71c; }
    h1 { color: #f9d71c; font-size: 1.8em; margin-bottom: 20px; }
    input { width:100%; padding:12px; margin:10px 0; border:none; outline:none; border-radius:6px; background:#111; color:#f9d71c; font-size:14px; border:1px solid #f9d71c; }
    button { width:100%; padding:12px; border:none; border-radius:6px; background:#f9d71c; color:#000; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#fff700; }
    .switch { color:#ccc; font-size:14px; margin-top:15px; cursor:pointer; }
    .footer { margin-top:25px; font-size:12px; color:#777; }
  </style>
</head>

<body>
  <div class="container">
    <h1>DPSTORE</h1>

    <!-- FORMULAIRE INSCRIPTION -->
    <div id="signup">
      <p>CrÃ©er ton compte</p>
      <input type="text" id="username" placeholder="Nom d'utilisateur" required />
      <input type="email" id="email" placeholder="Adresse email" required />
      <input type="password" id="password" placeholder="Mot de passe" required />
      <button onclick="sendVerificationCode()">ðŸ“§ Recevoir le code</button>

      <input type="text" id="code" placeholder="Entre le code reÃ§u" style="margin-top:15px;" />
      <button onclick="verifyCode()">âœ… VÃ©rifier le code</button>
      <p class="switch" onclick="toggleForms()">DÃ©jÃ  un compte ? Se connecter</p>
    </div>

    <!-- FORMULAIRE CONNEXION -->
    <div id="login" style="display: none;">
      <p>Connexion Ã  ton compte</p>
      <input type="email" id="loginEmail" placeholder="Adresse email" required />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required />
      <button onclick="loginUser()">ðŸš€ Se connecter</button>
      <p class="switch" onclick="toggleForms()">Pas encore inscrit ? CrÃ©er un compte</p>
    </div>
  </div>

  <p class="footer">Â© 2025 DPSTORE â€” Technologie avancÃ©e</p>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase (modular v9) loaded as module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      runTransaction,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ====== CONFIG FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
      authDomain: "dpstore-officie.firebaseapp.com",
      projectId: "dpstore-officie",
      storageBucket: "dpstore-officie.firebasestorage.app",
      messagingSenderId: "903943973062",
      appId: "1:903943973062:web:6501a2ec167adb31258fc7"
    };

    // Init
    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firestore initialisÃ©.");
    } catch (e) {
      console.warn("Firestore non initialisÃ© :", e);
    }

    // EmailJS init
    (function () { emailjs.init("5gObExmJ85l0pSXC3"); })();

    // pending registration in-memory
    let pendingRegistration = { email: null, username: null, password: null, verificationCode: null };

    // ===== UTIL: generate DP atomically via transaction
    async function getNextDPFromFirestore() {
      if (!db) throw new Error("Firestore non disponible");
      const counterRef = doc(db, "counters", "dp");
      const nextNum = await runTransaction(db, async (tx) => {
        const snap = await tx.get(counterRef);
        if (!snap.exists()) {
          tx.set(counterRef, { last: 1 });
          return 1;
        } else {
          const last = snap.data().last || 0;
          const next = last + 1;
          tx.update(counterRef, { last: next });
          return next;
        }
      });
      return "DP" + String(nextNum).padStart(6, "0");
    }

    // ===== UTIL: save emailjs log
    async function recordEmailJSSent(email, code) {
      try {
        if (!db) return;
        await addDoc(collection(db, "emailjs_sent"), { email, code, date: new Date().toISOString() });
      } catch (e) { console.warn("Erreur emailjs_sent :", e); }
    }

    // ===== UTIL: find user by email (query) - robust
    async function findUserByEmail(email) {
      if (!db) throw new Error("Firestore non disponible");
      const normalized = email.trim().toLowerCase();
      const q = query(collection(db, "users"), where("email", "==", normalized));
      const snaps = await getDocs(q);
      if (snaps.empty) return null;
      const d = snaps.docs[0];
      return { id: d.id, data: d.data() };
    }

    // ===== UTIL: find user by doc id (encoded email)
    async function getUserByDocId(email) {
      if (!db) throw new Error("Firestore non disponible");
      const id = encodeURIComponent(email.trim().toLowerCase());
      const snap = await getDoc(doc(db, "users", id));
      if (!snap.exists()) return null;
      return { id: snap.id, data: snap.data() };
    }

    // ===== UTIL: save user to Firestore (doc ID = encodeURIComponent(email))
    async function saveUserToFirestore(user) {
      if (!db) throw new Error("Firestore non disponible");
      const safeId = encodeURIComponent(user.email.trim().toLowerCase());
      const userRef = doc(db, "users", safeId);
      await setDoc(userRef, {
        username: user.username,
        email: user.email.trim().toLowerCase(),
        password: user.password,
        role: user.role,
        credits: Number(user.credits || 0),
        balance: Number(user.credits || 0), // keep balance in sync
        dp: user.dp,
        photo: user.photo || null,
        lastLogin: user.lastLogin || new Date().toLocaleString(),
        createdAt: user.createdAt || new Date().toISOString()
      }, { merge: true });
    }

    // ===== INIT creator account (safe)
    (async function initCreatorAccount() {
      try {
        if (!db) return;
        const creatorEmail = "christopherantoine773@gmail.com".toLowerCase();
        const found = await findUserByEmail(creatorEmail);
        if (!found) {
          const creator = {
            username: "DPSTORE",
            email: creatorEmail,
            password: "Blondy200ky444",
            role: "creator",
            credits: 0,
            dp: "DP000001",
            photo: "https://i.imgur.com/2XnKZ9R.png",
            lastLogin: new Date().toLocaleString(),
            createdAt: new Date().toISOString()
          };
          await saveUserToFirestore(creator);
          // ensure dp counter exists
          const counterRef = doc(db, "counters", "dp");
          const cSnap = await getDoc(counterRef);
          if (!cSnap.exists()) await setDoc(counterRef, { last: 1 }, { merge: true });
        } else {
          // sync balance field if missing
          const safeId = encodeURIComponent(creatorEmail);
          await setDoc(doc(db, "users", safeId), { balance: found.data.credits ?? 0 }, { merge: true });
        }
      } catch (e) {
        console.warn("Erreur initCreatorAccount :", e);
      }
    })();

    // ===== generate verification code
    function generateCode() { return Math.floor(100000 + Math.random() * 900000); }

    // ===== send verification code (signup flow)
    async function sendVerificationCode() {
      const emailEl = document.getElementById("email");
      const usernameEl = document.getElementById("username");
      const passwordEl = document.getElementById("password");

      const email = emailEl.value.trim().toLowerCase();
      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (!email || !username || !password) { alert("âš ï¸ Remplis tous les champs !"); return; }

      try {
        // check with query
        const exists = await findUserByEmail(email);
        if (exists) { alert("âš ï¸ Ce compte existe dÃ©jÃ  !"); return; }

        const code = generateCode();
        pendingRegistration = { email, username, password, verificationCode: String(code) };

        await recordEmailJSSent(email, code);

        const params = { user_email: email, to_name: username, message: String(code) };
        emailjs.send("service_1tnwnvu", "template_7o06ag8", params)
          .then(() => alert("âœ… Code envoyÃ© !"))
          .catch(err => { console.warn("EmailJS erreur:", err); alert("âŒ Erreur envoi email"); });
      } catch (e) {
        console.error("Erreur sendVerificationCode:", e);
        alert("âŒ Erreur lors de l'envoi du code.");
      }
    }

    // ===== determine role by email (small helper)
    function getRoleByEmail(email) {
      const CREATOR_EMAILS = ["christopherantoine773@gmail.com"];
      const EMPLOYEE_EMAILS = [
        "pilotecitizen@gmail.com",
        "ladouceurlorvynsky@gmail.com",
        "doresmaworldens@gmail.com",
        "mathieulherisson99@gmail.com"
      ];
      if (CREATOR_EMAILS.includes(email)) return "creator";
      if (EMPLOYEE_EMAILS.includes(email)) return "employee";
      return "user";
    }

    // ===== verifyCode (complete signup) =====
    async function verifyCode() {
      const entered = document.getElementById("code").value.trim();
      if (!pendingRegistration.verificationCode) { alert("âš ï¸ Aucun code en attente."); return; }
      if (String(entered) !== String(pendingRegistration.verificationCode)) { alert("âŒ Code incorrect !"); return; }

      try {
        const email = pendingRegistration.email.toLowerCase();
        const username = pendingRegistration.username;
        const password = pendingRegistration.password;

        // race check
        if (await findUserByEmail(email)) { alert("âš ï¸ Ce compte existe dÃ©jÃ  !"); return; }

        const role = getRoleByEmail(email);

        // generate DP
        let dp;
        try { dp = await getNextDPFromFirestore(); } catch (e) { dp = "DP" + String(Date.now()).slice(-6); }

        const userObj = {
          username,
          email,
          password,
          role,
          credits: 0,
          dp,
          photo: "https://i.imgur.com/2XnKZ9R.png",
          lastLogin: new Date().toLocaleString(),
          createdAt: new Date().toISOString()
        };

        // save
        await saveUserToFirestore(userObj);

        // create session payload (sessionStorage + localStorage for compatibility)
        const userPayload = {
          email: userObj.email,
          username: userObj.username,
          dp: userObj.dp,
          role: userObj.role,
          credits: userObj.credits,
          balance: userObj.credits
        };

        try {
          sessionStorage.setItem("dpstore_user", JSON.stringify(userPayload));
        } catch (e) { console.warn("sessionStorage indisponible :", e); }

        try {
          // keep localStorage for older pages compatibility (OPTION 2)
          localStorage.setItem("dpstore_user", JSON.stringify(userPayload));
        } catch (e) { console.warn("localStorage indisponible :", e); }

        alert("ðŸŽ‰ Compte crÃ©Ã© !");
        window.location.href = "profil.html";
      } catch (err) {
        console.error("Erreur verifyCode:", err);
        alert("âŒ Une erreur est survenue lors de la crÃ©ation du compte.");
      } finally {
        // clear pending
        pendingRegistration = { email: null, username: null, password: null, verificationCode: null };
      }
    }

    // ===== login flow =====
    async function loginUser() {
      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value.trim();

      if (!email || !password) { alert("âš ï¸ Remplis tous les champs !"); return; }

      try {
        // robust lookup: try query by email
        const found = await findUserByEmail(email);

        if (!found) { alert("âš ï¸ Aucun compte trouvÃ© !"); return; }

        const userData = found.data;

        if (userData.password !== password) { alert("âŒ Mot de passe incorrect !"); return; }

        // update lastLogin in Firestore (use doc id from found)
        await setDoc(doc(db, "users", found.id), { lastLogin: new Date().toLocaleString() }, { merge: true });

        // sync balance field if missing
        if (userData.credits !== undefined && userData.balance === undefined) {
          await setDoc(doc(db, "users", found.id), { balance: Number(userData.credits || 0) }, { merge: true });
        }

        // create session payload and store in both storages (compat)
        const userPayload = {
          email: userData.email,
          username: userData.username || userData.email.split("@")[0],
          dp: userData.dp,
          role: userData.role || "user",
          credits: Number(userData.credits || 0),
          balance: Number(userData.balance ?? userData.credits ?? 0)
        };

        try { sessionStorage.setItem("dpstore_user", JSON.stringify(userPayload)); } catch (e) { console.warn("sessionStorage indisponible :", e); }
        try { localStorage.setItem("dpstore_user", JSON.stringify(userPayload)); } catch (e) { console.warn("localStorage indisponible :", e); }

        alert("âœ… Connexion !");
        // redirect according to role
        if ((userPayload.role || "").toLowerCase() === "creator") window.location.href = "creator-space.html";
        else window.location.href = "profil.html";
      } catch (e) {
        console.error("Erreur loginUser:", e);
        alert("âŒ Erreur lors de la connexion.");
      }
    }

    function toggleForms() {
      const s = document.getElementById("signup");
      const l = document.getElementById("login");
      s.style.display = s.style.display === "none" ? "block" : "none";
      l.style.display = l.style.display === "none" ? "block" : "none";
    }

    // optional: fix duplicate DPs (keeps as-is)
    async function fixDuplicateDPs() {
      try {
        if (!db) return;
        const q = query(collection(db, "users"));
        const snaps = await getDocs(q);
        const dpMap = new Map();
        const updates = [];
        snaps.forEach(docSnap => {
          const data = docSnap.data();
          const dp = data.dp;
          if (!dp) return;
          if (dpMap.has(dp)) dpMap.get(dp).push({ id: docSnap.id, data });
          else dpMap.set(dp, [{ id: docSnap.id, data }]);
        });
        for (const [dp, arr] of dpMap.entries()) {
          if (arr.length > 1) {
            for (let i = 1; i < arr.length; i++) {
              const userId = arr[i].id;
              const newDP = await getNextDPFromFirestore();
              updates.push({ userId, newDP });
            }
          }
        }
        for (const u of updates) {
          await updateDoc(doc(db, "users", u.userId), { dp: u.newDP });
        }
        if (updates.length) console.log("DP duplicatÃ©s corrigÃ©s :", updates.length);
      } catch (e) { console.warn("Erreur fixDuplicateDPs:", e); }
    }
    fixDuplicateDPs().catch(()=>{});

    // expose functions (for onclick)
    window.sendVerificationCode = sendVerificationCode;
    window.verifyCode = verifyCode;
    window.loginUser = loginUser;
    window.toggleForms = toggleForms;

  </script>
</body>
</html>
