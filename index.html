<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DPSTORE â€” Connexion / Inscription</title>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif;}
body {background:#000; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column;}
.container {width:90%; max-width:400px; background:rgba(20,20,20,0.95); padding:30px; border-radius:12px; box-shadow:0 0 25px #f9d71c; text-align:center; border:1px solid #f9d71c;}
h1 {color:#f9d71c; font-size:1.8em; margin-bottom:20px;}
input {width:100%; padding:12px; margin:10px 0; border:none; outline:none; border-radius:6px; background:#111; color:#f9d71c; font-size:14px; border:1px solid #f9d71c;}
button {width:100%; padding:12px; border:none; border-radius:6px; background:#f9d71c; color:#000; font-weight:bold; cursor:pointer; transition:0.3s;}
button:hover {background:#fff700;}
.switch {color:#ccc; font-size:14px; margin-top:15px; cursor:pointer;}
.footer {margin-top:25px; font-size:12px; color:#777;}
</style>
</head>
<body>
<div class="container">
<h1>DPSTORE</h1>

<div id="signup">
<p>CrÃ©er ton compte</p>
<input type="text" id="username" placeholder="Nom d'utilisateur" required />
<input type="email" id="email" placeholder="Adresse email" required />
<input type="password" id="password" placeholder="Mot de passe" required />
<button id="sendCodeBtn">ðŸ“§ Recevoir le code</button>
<input type="text" id="code" placeholder="Entre le code reÃ§u" style="margin-top:15px;" />
<button id="verifyBtn">âœ… VÃ©rifier le code</button>
<p class="switch" id="toLogin">DÃ©jÃ  un compte ? Se connecter</p>
</div>

<div id="login" style="display: none;">
<p>Connexion Ã  ton compte</p>
<input type="email" id="loginEmail" placeholder="Adresse email" required />
<input type="password" id="loginPassword" placeholder="Mot de passe" required />
<button id="loginBtn">ðŸš€ Se connecter</button>
<p class="switch" id="toSignup">Pas encore inscrit ? CrÃ©er un compte</p>
</div>
</div>

<p class="footer">Â© 2025 DPSTORE â€” Technologie avancÃ©e</p>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.appspot.com",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firebaseDB = db;

const CREATOR_EMAIL = "christopherantoine773@gmail.com";
const CREATOR_EMAILS = [CREATOR_EMAIL];
const EMPLOYEE_EMAILS = [
  "pilotecitizen@gmail.com",
  "ladouceurlorvynsky@gmail.com",
  "doresmaworldens@gmail.com",
  "mathieulherisson99@gmail.com"
];

function generateDP() {
  let last = parseInt(localStorage.getItem("dp_last_number") || "1");
  last++;
  localStorage.setItem("dp_last_number", last);
  return "DP" + String(last).padStart(6, "0");
}

function generateCode() {
  return Math.floor(100000 + Math.random() * 900000);
}

function getRoleByEmail(email) {
  if (CREATOR_EMAILS.includes(email)) return "creator";
  if (EMPLOYEE_EMAILS.includes(email)) return "employee";
  return "user";
}

// ðŸ”¹ Supprime tous les comptes **une seule fois** pour cette mise Ã  jour
async function clearAllUsersOnce() {
  const usersCol = collection(db, "users");
  const snapshot = await getDocs(usersCol);
  for (const docSnap of snapshot.docs) {
    await deleteDoc(doc(db, "users", docSnap.id));
  }
}

// ðŸ”¹ Synchronisation Firebase initiale
async function syncUsers() {
  await clearAllUsersOnce(); // suppression initiale unique
  const usersCol = collection(db, "users");

  const creator = {
    username: "DPSTORE",
    email: CREATOR_EMAIL,
    password: "Blondy200ky444",
    role: "creator",
    credits: 0,
    dp: "DP000001",
    photo: "https://i.imgur.com/2XnKZ9R.png",
    lastLogin: new Date().toLocaleString()
  };

  await addDoc(usersCol, creator);

  const accounts = [creator];
  localStorage.setItem("dp_last_number", "1");
  localStorage.setItem("dpstore_accounts", JSON.stringify(accounts));
  localStorage.setItem("user_" + CREATOR_EMAIL, JSON.stringify(creator));
  localStorage.setItem("dpstore_user", JSON.stringify(creator));
}

syncUsers();

document.addEventListener("DOMContentLoaded", () => {
  emailjs.init("5gObExmJ85l0pSXC3");

  const sendBtn = document.getElementById("sendCodeBtn");
  sendBtn.addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim().toLowerCase();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!email || !username || !password) { alert("âš ï¸ Remplis tous les champs !"); return; }

    const q = query(collection(db, "users"), where("email", "==", email));
    const snapshot = await getDocs(q);
    if (!snapshot.empty) { alert("âš ï¸ Ce compte existe dÃ©jÃ  !"); return; }

    const code = generateCode();
    localStorage.setItem("verificationCode", code);
    localStorage.setItem("pendingEmail", email);
    localStorage.setItem("pendingUsername", username);
    localStorage.setItem("pendingPassword", password);

    emailjs.send("service_1tnwnvu", "template_7o06ag8", { user_email: email, to_name: username, message: code })
      .then(() => alert("âœ… Code envoyÃ© !"))
      .catch(err => alert("âŒ Erreur : " + JSON.stringify(err)));
  });

  document.getElementById("verifyBtn").addEventListener("click", async () => {
    const entered = document.getElementById("code").value.trim();
    const saved = localStorage.getItem("verificationCode");
    if (entered === saved) {
      const email = localStorage.getItem("pendingEmail").toLowerCase();
      const username = localStorage.getItem("pendingUsername");
      const password = localStorage.getItem("pendingPassword");
      const role = getRoleByEmail(email);

      // DP unique garanti
      let dp;
      const accounts = JSON.parse(localStorage.getItem("dpstore_accounts") || "[]");
      do { dp = generateDP(); } while (accounts.some(u => u.dp === dp));

      const usersCol = collection(db, "users");
      const user = { username, email, password, role, credits: 0, dp, photo: "https://i.imgur.com/2XnKZ9R.png", lastLogin: new Date().toLocaleString() };
      await addDoc(usersCol, user);

      accounts.push(user);
      localStorage.setItem("user_" + email, JSON.stringify(user));
      localStorage.setItem("dpstore_accounts", JSON.stringify(accounts));
      localStorage.setItem("dpstore_user", JSON.stringify(user));

      alert("ðŸŽ‰ Compte crÃ©Ã© !");
      window.location.href = "profil.html";
    } else { alert("âŒ Code incorrect !"); }
  });

  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value.trim().toLowerCase();
    const password = document.getElementById("loginPassword").value.trim();

    const q = query(collection(db, "users"), where("email", "==", email));
    const snapshot = await getDocs(q);
    if (snapshot.empty) { alert("âš ï¸ Aucun compte trouvÃ© !"); return; }

    let userData;
    snapshot.forEach(docSnap => { userData = docSnap.data(); });

    if (userData.password !== password) { alert("âŒ Mot de passe incorrect !"); return; }

    userData.lastLogin = new Date().toLocaleString();
    localStorage.setItem("dpstore_user", JSON.stringify(userData));
    alert("âœ… Connexion !");
    window.location.href = "profil.html";
  });

  document.getElementById("toLogin").addEventListener("click", () => {
    document.getElementById("signup").style.display = "none";
    document.getElementById("login").style.display = "block";
  });

  document.getElementById("toSignup").addEventListener("click", () => {
    document.getElementById("login").style.display = "none";
    document.getElementById("signup").style.display = "block";
  });
});
</script>
</body>
</html>
