<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPSTORE â€” Connexion / Inscription</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #000; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
    .container { width: 90%; max-width: 400px; background: rgba(20,20,20,0.95); padding: 30px; border-radius: 12px; box-shadow: 0 0 25px #f9d71c; text-align:center; border:1px solid #f9d71c; }
    h1 { color: #f9d71c; font-size: 1.8em; margin-bottom: 20px; }
    input { width:100%; padding:12px; margin:10px 0; border:none; outline:none; border-radius:6px; background:#111; color:#f9d71c; font-size:14px; border:1px solid #f9d71c; }
    button { width:100%; padding:12px; border:none; border-radius:6px; background:#f9d71c; color:#000; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#fff700; }
    .switch { color:#ccc; font-size:14px; margin-top:15px; cursor:pointer; }
    .footer { margin-top:25px; font-size:12px; color:#777; }
  </style>
</head>

<body>
  <div class="container">
    <h1>DPSTORE</h1>

    <!-- FORMULAIRE INSCRIPTION -->
    <div id="signup">
      <p>CrÃ©er ton compte</p>
      <input type="text" id="username" placeholder="Nom d'utilisateur" required />
      <input type="email" id="email" placeholder="Adresse email" required />
      <input type="password" id="password" placeholder="Mot de passe" required />
      <button onclick="sendVerificationCode()">ðŸ“§ Recevoir le code</button>

      <input type="text" id="code" placeholder="Entre le code reÃ§u" style="margin-top:15px;" />
      <button onclick="verifyCode()">âœ… VÃ©rifier le code</button>
      <p class="switch" onclick="toggleForms()">DÃ©jÃ  un compte ? Se connecter</p>
    </div>

    <!-- FORMULAIRE CONNEXION -->
    <div id="login" style="display: none;">
      <p>Connexion Ã  ton compte</p>
      <input type="email" id="loginEmail" placeholder="Adresse email" required />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required />
      <button onclick="loginUser()">ðŸš€ Se connecter</button>
      <p class="switch" onclick="toggleForms()">Pas encore inscrit ? CrÃ©er un compte</p>
    </div>
  </div>

  <p class="footer">Â© 2025 DPSTORE â€” Technologie avancÃ©e</p>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase (modular v9) loaded as module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      runTransaction,
      collection,
      addDoc,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
      authDomain: "dpstore-officie.firebaseapp.com",
      projectId: "dpstore-officie",
      storageBucket: "dpstore-officie.firebasestorage.app",
      messagingSenderId: "903943973062",
      appId: "1:903943973062:web:6501a2ec167adb31258fc7"
    };

    let firebaseApp = null;
    let db = null;
    try {
      firebaseApp = initializeApp(firebaseConfig);
      db = getFirestore(firebaseApp);
      console.log("Firestore initialisÃ©.");
    } catch (e) {
      console.warn("Firestore non initialisÃ© :", e);
    }

    (function () { emailjs.init("5gObExmJ85l0pSXC3"); })();

    let pendingRegistration = {
      email: null,
      username: null,
      password: null,
      verificationCode: null
    };

    async function getNextDPFromFirestore() {
      if (!db) throw new Error("Firestore non disponible");
      const counterRef = doc(db, "counters", "dp");
      const newNum = await runTransaction(db, async (tx) => {
        const snap = await tx.get(counterRef);
        if (!snap.exists()) {
          tx.set(counterRef, { last: 1 });
          return 1;
        } else {
          const last = snap.data().last || 0;
          const next = last + 1;
          tx.update(counterRef, { last: next });
          return next;
        }
      });
      return "DP" + String(newNum).padStart(6, "0");
    }

    async function recordEmailJSSent(email, code) {
      try { if (db) await addDoc(collection(db, "emailjs_sent"), { email, code, date: new Date().toISOString() }); } 
      catch (e) { console.warn("Erreur emailjs_sent :", e); }
    }

    async function userExists(email) {
      if (!db) throw new Error("Firestore non disponible");
      const q = query(collection(db, "users"), where("email", "==", email.toLowerCase()));
      const snaps = await getDocs(q);
      return !snaps.empty;
    }

    async function saveUserToFirestore(user) {
      if (!db) throw new Error("Firestore non disponible");
      const safeId = encodeURIComponent(user.email);
      const userRef = doc(db, "users", safeId);
      await setDoc(userRef, {
        username: user.username,
        email: user.email,
        password: user.password,
        role: user.role,
        credits: user.credits || 0,
        dp: user.dp,
        photo: user.photo || null,
        lastLogin: user.lastLogin || new Date().toLocaleString(),
        createdAt: user.createdAt || new Date().toISOString()
      }, { merge: true });
    }

    async function fetchUserByEmail(email) {
      if (!db) throw new Error("Firestore non disponible");
      email = email.trim().toLowerCase();
      const q = query(collection(db, "users"), where("email", "==", email));
      const snaps = await getDocs(q);
      if (!snaps.empty) return snaps.docs[0].data();
      return null;
    }

    (async function initCreatorAccount() {
      try {
        const creatorEmail = "christopherantoine773@gmail.com".toLowerCase();
        if (!db) return;
        const exists = await userExists(creatorEmail);
        if (!exists) {
          const creator = {
            username: "DPSTORE",
            email: creatorEmail,
            password: "Blondy200ky444",
            role: "creator",
            credits: 0,
            dp: "DP000001",
            photo: "https://i.imgur.com/2XnKZ9R.png",
            lastLogin: new Date().toLocaleString(),
            createdAt: new Date().toISOString()
          };
          await saveUserToFirestore(creator);
          const counterRef = doc(db, "counters", "dp");
          const snap = await getDoc(counterRef);
          if (!snap.exists()) await setDoc(counterRef, { last: 1 });
        }
      } catch (e) { console.warn("Erreur initCreatorAccount :", e); }
    })();

    function generateCode() { return Math.floor(100000 + Math.random() * 900000); }

    async function sendVerificationCode() {
      const email = document.getElementById("email").value.trim().toLowerCase();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !username || !password) { alert("âš ï¸ Remplis tous les champs !"); return; }
      if (db && await userExists(email)) { alert("âš ï¸ Ce compte existe dÃ©jÃ  !"); return; }
      const code = generateCode();
      pendingRegistration = { email, username, password, verificationCode: String(code) };
      await recordEmailJSSent(email, code);
      emailjs.send("service_1tnwnvu", "template_7o06ag8", { user_email: email, to_name: username, message: String(code) })
        .then(() => alert("âœ… Code envoyÃ© !"))
        .catch(err => { console.warn("EmailJS erreur:", err); alert("âŒ Erreur : " + JSON.stringify(err)); });
    }

    function getRoleByEmail(email) {
      const CREATOR_EMAILS = ["christopherantoine773@gmail.com"];
      const EMPLOYEE_EMAILS = [
        "pilotecitizen@gmail.com",
        "ladouceurlorvynsky@gmail.com",
        "doresmaworldens@gmail.com",
        "mathieulherisson99@gmail.com"
      ];
      if (CREATOR_EMAILS.includes(email)) return "creator";
      if (EMPLOYEE_EMAILS.includes(email)) return "employee";
      return "user";
    }

    async function verifyCode() {
      const entered = document.getElementById("code").value.trim();
      if (!pendingRegistration.verificationCode) { alert("âš ï¸ Aucun code en attente."); return; }
      if (String(entered) === String(pendingRegistration.verificationCode)) {
        const { email, username, password } = pendingRegistration;
        if (db && await userExists(email)) { alert("âš ï¸ Ce compte existe dÃ©jÃ  !"); return; }
        const role = getRoleByEmail(email);
        let dp;
        try { dp = db ? await getNextDPFromFirestore() : "DP" + String(Date.now()).slice(-6); } 
        catch (e) { dp = "DP" + String(Date.now()).slice(-6); console.warn(e); }
        const user = { username, email, password, role, credits: 0, dp, photo:"https://i.imgur.com/2XnKZ9R.png", lastLogin:new Date().toLocaleString(), createdAt:new Date().toISOString() };
        await saveUserToFirestore(user);
        sessionStorage.setItem("dpstore_user", JSON.stringify({ email:user.email, username:user.username, dp:user.dp, role:user.role, credits:user.credits }));
        alert("ðŸŽ‰ Compte crÃ©Ã© !");
        window.location.href = "profil.html";
      } else alert("âŒ Code incorrect !");
    }

    async function loginUser() {
      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value.trim();
      if (!email || !password) { alert("âš ï¸ Remplis tous les champs !"); return; }
      const user = await fetchUserByEmail(email);
      if (!user) { alert("âš ï¸ Aucun compte trouvÃ© !"); return; }
      if (user.password !== password) { alert("âŒ Mot de passe incorrect !"); return; }
      await setDoc(doc(db, "users", encodeURIComponent(email)), { lastLogin: new Date().toLocaleString() }, { merge: true });
      sessionStorage.setItem("dpstore_user", JSON.stringify({ email:user.email, username:user.username, dp:user.dp, role:user.role, credits:user.credits }));
      alert("âœ… Connexion !");
      window.location.href = "profil.html";
    }

    function toggleForms() {
      const s = document.getElementById("signup");
      const l = document.getElementById("login");
      s.style.display = s.style.display === "none" ? "block" : "none";
      l.style.display = l.style.display === "none" ? "block" : "none";
    }

    async function fixDuplicateDPs() {
      try {
        if (!db) return;
        const snaps = await getDocs(collection(db, "users"));
        const dpMap = new Map();
        const updates = [];
        snaps.forEach(docSnap => {
          const data = docSnap.data();
          if (!data.dp) return;
          if (dpMap.has(data.dp)) dpMap.get(data.dp).push({ id: docSnap.id, data }); 
          else dpMap.set(data.dp, [{ id: docSnap.id, data }]);
        });
        for (const [dp, arr] of dpMap.entries()) {
          if (arr.length > 1) {
            for (let i = 1; i < arr.length; i++) {
              const userId = arr[i].id;
              const newDP = await getNextDPFromFirestore();
              updates.push({ userId, newDP });
            }
          }
        }
        for (const u of updates) await updateDoc(doc(db, "users", u.userId), { dp: u.newDP });
        if (updates.length) console.log("DP duplicatÃ©s corrigÃ©s :", updates.length);
      } catch (e) { console.warn("Erreur fixDuplicateDPs:", e); }
    }
    fixDuplicateDPs().catch(()=>{});

    window.sendVerificationCode = sendVerificationCode;
    window.verifyCode = verifyCode;
    window.loginUser = loginUser;
    window.toggleForms = toggleForms;

  </script>
</body>
</html>
