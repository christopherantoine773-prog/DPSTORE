<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Profil ‚Äî DPSTORE</title>

<style>
body{
    background:black;
    color:white;
    font-family:Arial;
    text-align:center;
}

.profile-box{
    width:90%;
    margin:40px auto;
    padding:20px;
    background:#111;
    border-radius:15px;
    box-shadow:0 0 25px #fdf100;
}

#profile-pic{
    width:120px;
    height:120px;
    border-radius:50%;
    border:4px solid #fdf100;
    object-fit:cover;
}

.tiktok-badge{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    width:18px;
    height:18px;
    background:#2aa6ff;
    border-radius:50%;
    font-size:12px;
    color:white;
    font-weight:bold;
    margin-left:6px;
}

button{
    padding:12px 20px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}

#changePhotoBtn{
    background:yellow;
    color:black;
}

#savePhotoBtn{
    background:#0099ff;
    display:none;
}

.red{
    background:red;
    color:white;
}

.creator-btn{
    background:#00eaff;
    color:black;
    width:90%;
    margin-top:20px;
    padding:14px;
    border-radius:12px;
    font-size:18px;
    box-shadow:0 0 15px #00eaff;
    display:none;
}
</style>
</head>
<body>

<div class="profile-box">

    <img id="profile-pic" src="" alt="Photo de profil">
    <br>
    <button id="changePhotoBtn">üì∏ Modifier la photo</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <br>
    <button id="savePhotoBtn">üíæ Sauvegarder</button>

    <h2>
        <span id="name"></span>
        <span id="badge"></span>
    </h2>

    <h3 id="dp-id" style="color:#00aaff;"></h3>
    <p id="email"></p>

    <p>
        R√¥le :
        <span id="role" style="color:#00aaff; font-weight:bold;"></span>
    </p>

    <p style="color:yellow; font-size:18px;">
        üí∞ Solde : <span id="credits">0</span> cr√©dits
    </p>

    <p style="margin-top:10px;">
        Derni√®re connexion : <span id="lastLogin"></span>
    </p>

    <button id="creatorModeBtn" class="creator-btn" onclick="location.href='creator-space.html'">üöÄ MODE CREATOR / ADMIN</button>
    <button id="employeeBtn" class="creator-btn" onclick="location.href='employee.html'" style="background:#ffae00; box-shadow:0 0 15px #ffae00; display:none;">üõ†Ô∏è ESPACE EMPLOY√â</button>
    <button id="tmmBtn" class="creator-btn" style="background:#00ff90; box-shadow:0 0 15px #00ff90; display:block;" onclick="location.href='tmm.html'">üõ†Ô∏è Gestion Commandes (TMM)</button>
    <button id="adminBtn" style="display:none; margin-top:15px; border-radius:50%; width:60px; height:60px; font-size:24px; background:#00aaff; color:white; border:none; cursor:pointer;" title="Admin / Creator" onclick="location.href='admin.html'">üõ†Ô∏è</button>
    <button onclick="location.href='pub.html'" style="background:#ffaa00; color:black; width:90%; margin-top:15px; padding:14px; border-radius:12px; font-size:18px; font-weight:bold;">üì¢ Voir les pubs</button>
    <button onclick="location.href='piyaylakay.html'" style="background:#00ff88; color:black; width:90%; margin-top:15px; padding:14px; border-radius:12px; font-size:18px; font-weight:bold;">üéØ Piyaylakay</button>
    <button onclick="location.href='produits.html'">‚¨ÖÔ∏è Retour aux produits</button>
    <button class="red" onclick="logout()">D√©connexion</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.appspot.com",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentEmail = localStorage.getItem("dpstore_currentEmail"); // email enregistr√© lors de login
if(!currentEmail){ alert("Aucun compte connect√© !"); location.href="index.html"; }

let userDocRef = null;
let account = null;

async function loadProfile(email){
  const usersCol = collection(db, "users");
  const q = query(usersCol, where("email","==",email));
  const snapshot = await getDocs(q);
  if(snapshot.empty){ alert("Compte introuvable !"); location.href="index.html"; return; }
  userDocRef = snapshot.docs[0].ref;
  return snapshot.docs[0].data();
}

account = await loadProfile(currentEmail);

document.getElementById("name").textContent = account.username;
document.getElementById("dp-id").textContent = account.dp;
document.getElementById("email").textContent = account.email;
document.getElementById("credits").textContent = account.credits ?? 0;
document.getElementById("lastLogin").textContent = account.lastLogin ?? "‚Äî";
document.getElementById("profile-pic").src = account.photo || "https://via.placeholder.com/120x120?text=DP";

let r = (account.role ?? "").toLowerCase();
document.getElementById("role").textContent = r === "creator" ? "Cr√©ateur" : r === "admin" ? "Administrateur" : r === "employee" ? "Employ√©" : "Utilisateur";
document.getElementById("creatorModeBtn").style.display = (r==="creator"||r==="admin") ? "block":"none";
document.getElementById("employeeBtn").style.display = (r==="employee") ? "block":"none";
document.getElementById("adminBtn").style.display = (r==="creator"||r==="admin"||r==="employee") ? "inline-block":"none";

document.getElementById("changePhotoBtn").onclick = ()=>document.getElementById("photoInput").click();
document.getElementById("photoInput").onchange = e=>{
  let file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = evt=>{
    document.getElementById("profile-pic").src = evt.target.result;
    document.getElementById("savePhotoBtn").style.display="inline-block";
  };
  reader.readAsDataURL(file);
};

document.getElementById("savePhotoBtn").onclick = async ()=>{
  let newPhoto = document.getElementById("profile-pic").src;
  await updateDoc(userDocRef, { photo:newPhoto });
  document.getElementById("savePhotoBtn").style.display="none";
  alert("Photo mise √† jour !");
};

function logout(){ localStorage.removeItem("dpstore_currentEmail"); location.href="index.html"; }
document.querySelector(".red").onclick = logout;
</script>

</body>
</html>
