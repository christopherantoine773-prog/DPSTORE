<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Profil ‚Äî DPSTORE</title>

<style>
body{
    background:black;
    color:white;
    font-family:Arial, sans-serif;
    text-align:center;
}

.profile-box{
    width:90%;
    margin:40px auto;
    padding:20px;
    background:#111;
    border-radius:15px;
    box-shadow:0 0 25px #fdf100;
}

#profile-pic{
    width:120px;
    height:120px;
    border-radius:50%;
    border:4px solid #fdf100;
    object-fit:cover;
}

.tiktok-badge{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    width:18px;
    height:18px;
    background:#2aa6ff;
    border-radius:50%;
    font-size:12px;
    color:white;
    font-weight:bold;
    margin-left:6px;
}

button{
    padding:12px 20px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}

#changePhotoBtn{
    background:yellow;
    color:black;
}

#savePhotoBtn{
    background:#0099ff;
    display:none;
}

.red{
    background:red;
    color:white;
}

.creator-btn{
    background:#00eaff;
    color:black;
    width:90%;
    margin-top:20px;
    padding:14px;
    border-radius:12px;
    font-size:18px;
    box-shadow:0 0 15px #00eaff;
    display:none;
}
</style>
</head>
<body>

<div class="profile-box">

    <img id="profile-pic" src="" alt="Photo de profil">
    <br>
    <button id="changePhotoBtn">üì∏ Modifier la photo</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <br>
    <button id="savePhotoBtn">üíæ Sauvegarder</button>

    <h2>
        <span id="name"></span>
        <span id="badge"></span>
    </h2>

    <h3 id="dp-id" style="color:#00aaff;"></h3>
    <p id="email"></p>

    <p>
        R√¥le :
        <span id="role" style="color:#00aaff; font-weight:bold;"></span>
    </p>

    <p style="color:yellow; font-size:18px;">
        üí∞ Solde : <span id="credits">0</span> cr√©dits
    </p>

    <p style="margin-top:10px;">
        Derni√®re connexion : <span id="lastLogin"></span>
    </p>

    <button id="creatorModeBtn" class="creator-btn"
            onclick="location.href='creator-space.html'">
        üöÄ MODE CREATOR / ADMIN
    </button>

    <button id="employeeBtn" class="creator-btn"
            onclick="location.href='employee.html'"
            style="background:#ffae00; box-shadow:0 0 15px #ffae00; display:none;">
        üõ†Ô∏è ESPACE EMPLOY√â
    </button>

    <button onclick="location.href='produits.html'">‚¨ÖÔ∏è Retour aux produits</button>
    <button class="red" onclick="logout()">D√©connexion</button>

</div>

<!-- ==================== SCRIPT ==================== -->
<script type="module">

// ====== FIREBASE ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.appspot.com",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// ====== AUTHENTIFICATION ======
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        alert("Aucun compte d√©tect√© !");
        location.href = "index.html";
        return;
    }

    const email = encodeURIComponent(user.email);
    const userRef = doc(db, "users", email);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
        alert("Erreur : compte introuvable dans Firestore !");
        location.href = "index.html";
        return;
    }

    const account = snap.data();

    // ====== AFFICHAGE ======
    document.getElementById("name").textContent = account.username;
    document.getElementById("email").textContent = user.email;
    document.getElementById("dp-id").textContent = account.dp;
    document.getElementById("credits").textContent = account.credits ?? 0;
    document.getElementById("lastLogin").textContent = account.lastLogin ?? "‚Äî";

    // Badge
    if (["creator","admin","employee"].includes(account.role)) {
        document.getElementById("badge").innerHTML = `<span class="tiktok-badge">‚úî</span>`;
    }

    // R√¥le
    document.getElementById("role").textContent =
        account.role === "creator" ? "Cr√©ateur" :
        account.role === "employee" ? "Employ√©" :
        account.role === "admin" ? "Administrateur" : "Utilisateur";

    // Acc√®s sp√©ciaux
    if (["creator","admin"].includes(account.role)) {
        document.getElementById("creatorModeBtn").style.display = "block";
    }
    if (account.role === "employee") {
        document.getElementById("employeeBtn").style.display = "block";
    }

    // Photo
    document.getElementById("profile-pic").src = account.photo || "https://via.placeholder.com/120";

    // ===== MODIFIER PHOTO =====
    document.getElementById("changePhotoBtn").onclick = () => {
        document.getElementById("photoInput").click();
    };

    document.getElementById("photoInput").onchange = (e) => {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = x => {
            document.getElementById("profile-pic").src = x.target.result;
            document.getElementById("savePhotoBtn").style.display = "inline-block";
        };
        reader.readAsDataURL(file);
    };

    // ===== SAUVEGARDER PHOTO =====
    document.getElementById("savePhotoBtn").onclick = async () => {
        await setDoc(userRef, {
            photo: document.getElementById("profile-pic").src
        }, { merge: true });

        alert("Photo enregistr√©e !");
        document.getElementById("savePhotoBtn").style.display = "none";
    };

});

// ====== D√âCONNEXION ======
function logout() {
    signOut(auth).then(() => {
        location.href = "index.html";
    });
}
window.logout = logout;

</script>

</body>
</html>
