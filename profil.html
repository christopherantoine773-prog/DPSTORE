<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Profil ‚Äî DPSTORE</title>

<style>
body{
    background:black;
    color:white;
    font-family:Arial;
    text-align:center;
}

.profile-box{
    width:90%;
    margin:40px auto;
    padding:20px;
    background:#111;
    border-radius:15px;
    box-shadow:0 0 25px #fdf100;
}

#profile-pic{
    width:120px;
    height:120px;
    border-radius:50%;
    border:4px solid #fdf100;
    object-fit:cover;
}

.tiktok-badge{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    width:18px;
    height:18px;
    background:#2aa6ff;
    border-radius:50%;
    font-size:12px;
    color:white;
    font-weight:bold;
    margin-left:6px;
}

button{
    padding:12px 20px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}

#changePhotoBtn{
    background:yellow;
    color:black;
}

#savePhotoBtn{
    background:#0099ff;
    display:none;
}

.red{
    background:red;
    color:white;
}

.creator-btn{
    background:#00eaff;
    color:black;
    width:90%;
    margin-top:20px;
    padding:14px;
    border-radius:12px;
    font-size:18px;
    box-shadow:0 0 15px #00eaff;
    display:none;
}
</style>
</head>
<body>

<div class="profile-box">

    <img id="profile-pic" src="" alt="Photo de profil">
    <br>
    <button id="changePhotoBtn">üì∏ Modifier la photo</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <br>
    <button id="savePhotoBtn">üíæ Sauvegarder</button>

    <h2>
        <span id="name"></span>
        <span id="badge"></span>
    </h2>

    <h3 id="dp-id" style="color:#00aaff;"></h3>
    <p id="email"></p>

    <p>
        R√¥le :
        <span id="role" style="color:#00aaff; font-weight:bold;"></span>
    </p>

    <p style="color:yellow; font-size:18px;">
        üí∞ Solde : <span id="credits">0</span> cr√©dits
    </p>

    <p style="margin-top:10px;">
        Derni√®re connexion : <span id="lastLogin"></span>
    </p>

    <button id="creatorModeBtn" class="creator-btn"
            onclick="location.href='creator-space.html'">
        üöÄ MODE CREATOR / ADMIN
    </button>

    <button id="employeeBtn" class="creator-btn"
            onclick="location.href='employee.html'"
            style="background:#ffae00; box-shadow:0 0 15px #ffae00; display:none;">
        üõ†Ô∏è ESPACE EMPLOY√â
    </button>

    <button onclick="location.href='produits.html'">‚¨ÖÔ∏è Retour aux produits</button>
    <button class="red" onclick="logout()">D√©connexion</button>

</div>

<!-- ==================== SCRIPT ==================== -->
<script type="module">

// ====== FIREBASE ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.appspot.com",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== CHARGEMENT DU COMPTE ======
let account = JSON.parse(localStorage.getItem("dpstore_user"));
if(!account){
    alert("Aucun compte d√©tect√© !");
    location.href = "index.html";
}

// ====== R√âCUP√âRATION DES DONN√âES FIRESTORE ======
async function loadUserFromFirestore(){
    try{
        const safeId = encodeURIComponent(account.email);
        const userRef = doc(db,"users",safeId);
        const snap = await getDoc(userRef);

        if(snap.exists()){
            const data = snap.data();

            account.username = data.username;
            account.dp       = data.dp;
            account.role     = data.role;
            account.credits  = data.credits ?? 0;
            account.photo    = data.photo;
            account.lastLogin = data.lastLogin;

            localStorage.setItem("dpstore_user",JSON.stringify(account));
        }
    }catch(e){
        console.warn("Erreur Firestore:", e);
    }
}

await loadUserFromFirestore();

// ====== AFFICHAGE ======
document.getElementById("name").textContent = account.username;
document.getElementById("email").textContent = account.email;
document.getElementById("dp-id").textContent = account.dp;
document.getElementById("credits").textContent = account.credits;
document.getElementById("lastLogin").textContent = account.lastLogin ?? "‚Äî";

// ===== Badge =====
if(account.role === "creator" || account.role === "employee" || account.role === "admin"){
    document.getElementById("badge").innerHTML = `<span class="tiktok-badge">‚úî</span>`;
}

// ===== R√¥le =====
document.getElementById("role").textContent = 
    account.role === "creator" ? "Cr√©ateur" :
    account.role === "employee" ? "Employ√©" :
    account.role === "admin" ? "Administrateur" : "Utilisateur";

// ===== Boutons sp√©ciaux =====
if(account.role === "creator" || account.role === "admin"){
    document.getElementById("creatorModeBtn").style.display = "block";
}
if(account.role === "employee"){
    document.getElementById("employeeBtn").style.display = "block";
}

// ===== Photo =====
document.getElementById("profile-pic").src = account.photo || "https://via.placeholder.com/120";

// Modifier photo
document.getElementById("changePhotoBtn").onclick = () =>{
    document.getElementById("photoInput").click();
};

document.getElementById("photoInput").onchange = e =>{
    let file = e.target.files[0];
    let reader = new FileReader();
    reader.onload = x =>{
        document.getElementById("profile-pic").src = x.target.result;
        document.getElementById("savePhotoBtn").style.display = "inline-block";
    };
    reader.readAsDataURL(file);
};

// Sauvegarder photo
document.getElementById("savePhotoBtn").onclick = async()=>{
    account.photo = document.getElementById("profile-pic").src;

    localStorage.setItem("dpstore_user",JSON.stringify(account));

    const safeId = encodeURIComponent(account.email);
    await setDoc(doc(db,"users",safeId),{
        photo: account.photo
    },{merge:true});

    alert("Photo enregistr√©e !");
    document.getElementById("savePhotoBtn").style.display = "none";
};

// D√©connexion
function logout(){
    localStorage.removeItem("dpstore_user");
    location.href = "index.html";
}
window.logout = logout;

</script>

</body>
</html>
