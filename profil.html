<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Profil ‚Äî DPSTORE</title>

<style>
body{
    background:black;
    color:white;
    font-family:Arial;
    text-align:center;
}

.profile-box{
    width:90%;
    margin:40px auto;
    padding:20px;
    background:#111;
    border-radius:15px;
    box-shadow:0 0 25px #fdf100;
}

#profile-pic{
    width:120px;
    height:120px;
    border-radius:50%;
    border:4px solid #fdf100;
    object-fit:cover;
}

.tiktok-badge{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    width:18px;
    height:18px;
    background:#2aa6ff;
    border-radius:50%;
    font-size:12px;
    color:white;
    font-weight:bold;
    margin-left:6px;
}

button{
    padding:12px 20px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}

#changePhotoBtn{
    background:yellow;
    color:black;
}

#savePhotoBtn{
    background:#0099ff;
    display:none;
}

.red{
    background:red;
    color:white;
}

.creator-btn{
    background:#00eaff;
    color:black;
    width:90%;
    margin-top:20px;
    padding:14px;
    border-radius:12px;
    font-size:18px;
    box-shadow:0 0 15px #00eaff;
    display:none;
}
</style>
</head>
<body>

<div class="profile-box">

    <img id="profile-pic" src="" alt="Photo de profil">
    <br>
    <button id="changePhotoBtn">üì∏ Modifier la photo</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <br>
    <button id="savePhotoBtn">üíæ Sauvegarder</button>

    <h2>
        <span id="name"></span>
        <span id="badge"></span>
    </h2>

    <h3 id="dp-id" style="color:#00aaff;"></h3>
    <p id="email"></p>

    <p>
        R√¥le :
        <span id="role" style="color:#00aaff; font-weight:bold;"></span>
    </p>

    <p style="color:yellow; font-size:18px;">
        üí∞ Solde : <span id="credits">0</span> cr√©dits
    </p>

    <p style="margin-top:10px;">
        Derni√®re connexion : <span id="lastLogin"></span>
    </p>

    <button id="creatorModeBtn" class="creator-btn"
            onclick="location.href='creator-space.html'">
        üöÄ MODE CREATOR / ADMIN
    </button>

    <button id="employeeBtn" class="creator-btn"
            onclick="location.href='employee.html'"
            style="background:#ffae00; box-shadow:0 0 15px #ffae00; display:none;">
        üõ†Ô∏è ESPACE EMPLOY√â
    </button>

    <button onclick="location.href='produits.html'">‚¨ÖÔ∏è Retour aux produits</button>
    <button class="red" onclick="logout()">D√©connexion</button>

</div>

<!-- ==================== SCRIPT ==================== -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// ====== FIREBASE CONFIG ======
const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.appspot.com",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== Lecture sessionStorage ======
let sessionAccount = null;
try{
    sessionAccount = JSON.parse(sessionStorage.getItem("dpstore_user"));
}catch(e){
    sessionAccount = null;
}

if(!sessionAccount || !sessionAccount.email){
    alert("Aucun compte d√©tect√© !");
    location.href = "index.html";
}

// ====== R√©cup√©ration depuis Firestore ======
async function loadUser(){
    try{
        const safeId = encodeURIComponent(sessionAccount.email.trim().toLowerCase());
        const userRef = doc(db,"users",safeId);
        const snap = await getDoc(userRef);

        let account = sessionAccount;
        if(snap.exists()){
            const data = snap.data();
            account = {
                email: data.email ?? sessionAccount.email,
                username: data.username ?? sessionAccount.username,
                dp: data.dp ?? sessionAccount.dp ?? "‚Äî",
                role: data.role ?? sessionAccount.role ?? "user",
                credits: Number(data.credits ?? data.balance ?? sessionAccount.credits ?? 0),
                balance: Number(data.balance ?? data.credits ?? sessionAccount.balance ?? 0),
                photo: data.photo ?? sessionAccount.photo ?? null,
                lastLogin: data.lastLogin ?? sessionAccount.lastLogin ?? "‚Äî",
                createdAt: data.createdAt ?? "‚Äî",
                employeeType: data.employeeType ?? sessionAccount.employeeType ?? null
            };
            // MAJ sessionStorage
            sessionStorage.setItem("dpstore_user", JSON.stringify(account));
        }

        // ====== AFFICHAGE ======
        document.getElementById("name").textContent = account.username;
        document.getElementById("email").textContent = account.email;
        document.getElementById("dp-id").textContent = account.dp;
        document.getElementById("credits").textContent = account.balance;
        document.getElementById("lastLogin").textContent = account.lastLogin;

        // Badge
        if(["creator","employee","admin"].includes(account.role)){
            document.getElementById("badge").innerHTML = `<span class="tiktok-badge">‚úî</span>`;
        }

        // R√¥le
        document.getElementById("role").textContent =
            account.role === "creator" ? "Cr√©ateur" :
            account.role === "employee" ? "Employ√©" :
            account.role === "admin" ? "Administrateur" : "Utilisateur";

        // Boutons sp√©ciaux
        if(["creator","admin"].includes(account.role)){
            document.getElementById("creatorModeBtn").style.display = "block";
        }
        if(account.role === "employee"){
            document.getElementById("employeeBtn").style.display = "block";
        }

        // Photo
        document.getElementById("profile-pic").src = account.photo || "https://via.placeholder.com/120";

    }catch(e){
        console.warn("Erreur Firestore:", e);
        alert("Erreur en r√©cup√©rant les donn√©es. Recharge la page.");
    }
}

await loadUser();

// ===== Modifier photo =====
document.getElementById("changePhotoBtn").onclick = () => document.getElementById("photoInput").click();
document.getElementById("photoInput").onchange = e => {
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = evt => {
        document.getElementById("profile-pic").src = evt.target.result;
        document.getElementById("savePhotoBtn").style.display = "inline-block";
    };
    reader.readAsDataURL(file);
};

// ===== Sauvegarder photo (Firestore + sessionStorage) =====
document.getElementById("savePhotoBtn").onclick = async() => {
    try{
        let account = JSON.parse(sessionStorage.getItem("dpstore_user"));
        const safeId = encodeURIComponent(account.email.trim().toLowerCase());
        const photoData = document.getElementById("profile-pic").src;

        await setDoc(doc(db,"users",safeId), { photo: photoData }, { merge:true });

        account.photo = photoData;
        sessionStorage.setItem("dpstore_user", JSON.stringify(account));

        alert("Photo enregistr√©e !");
        document.getElementById("savePhotoBtn").style.display = "none";
    }catch(e){
        console.warn("Erreur sauvegarde photo:", e);
        alert("Erreur lors de l'enregistrement.");
    }
};

// ===== D√©connexion =====
function logout(){
    sessionStorage.removeItem("dpstore_user");
    location.href = "index.html";
}
window.logout = logout;

</script>

</body>
</html>
