<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Creator Space ‚Äî DPSTORE</title>

<style>
body{
    background:black;
    color:white;
    font-family:Arial;
    padding:20px;
}

/* ====== BOX ====== */
.box{
    background:#111;
    padding:20px;
    border-radius:15px;
    width:95%;
    margin:auto;
    margin-bottom:20px;
    box-shadow:0 0 20px #00eaff;
}

/* ====== INPUTS / BUTTONS ====== */
input, button, select{
    width:95%;
    margin-top:10px;
    padding:12px;
    border-radius:10px;
    border:none;
    font-size:16px;
}
button{
    background:#00eaff;
    color:black;
    font-weight:bold;
    cursor:pointer;
}

/* ===== TITRES ====== */
h2{
    color:#00eaff;
    text-align:center;
}

/* ====== REQUEST (recharges) ====== */
.request{
    background:#222;
    padding:12px;
    border-radius:10px;
    margin-top:15px;
    border-left:4px solid #00eaff;
}
.request img{
    width:100%;
    border-radius:10px;
    margin-top:10px;
    border:1px solid #00eaff;
}
.btnRow{
    display:flex;
    gap:10px;
    margin-top:10px;
}
.btnGreen{
    background:#00ff88;
    color:black;
    font-weight:bold;
}
.btnRed{
    background:#ff4444;
    color:white;
    font-weight:bold;
}

/* STATUS BADGE */
.status{
    font-weight:bold;
    padding:3px 8px;
    border-radius:5px;
}
.status.pending{background:#555;}
.status.validated{background:#00ff88;color:black;}
.status.refused{background:#ff4444;}

/* ===== MENU STYLE SMMTRENDING ===== */
.selectorBox{
    width:95%;
    background:#007bff;
    padding:15px;
    border-radius:14px;
    margin:auto;
    color:white;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:18px;
    cursor:pointer;
    margin-bottom:10px;
    box-shadow:0 0 12px #007bff;
}

.selectorBox img{
    width:30px;
    margin-right:10px;
}

.optionList{
    width:95%;
    background:#004ea3;
    border-radius:12px;
    margin:auto;
    margin-bottom:15px;
    display:none;
    overflow:hidden;
    box-shadow:0 0 12px #004ea3;
}

.optionItem{
    padding:12px 15px;
    border-bottom:1px solid rgba(255,255,255,0.15);
    cursor:pointer;
}
.optionItem:hover{
    background:#0060cc;
}
</style>
</head>
<body>

<h2>üöÄ MODE CREATOR / ADMIN</h2>

<!-- üîµ MINI BOUTON DP -->
<button style="
    background:#00eaff;
    color:black;
    font-weight:bold;
    padding:6px 14px;
    border-radius:8px;
    font-size:14px;
    margin-bottom:10px;
    cursor:pointer;
    width:auto;
" onclick="location.href='dp.html'">
    DP
</button>

<!-- =====================================================
     üîΩ SELECTEUR STYLE SMMTRENDING
===================================================== -->
<div class="selectorBox" onclick="toggleMenu()">
    <div style="display:flex;align-items:center;">
        <img src="https://cdn-icons-png.flaticon.com/512/833/833524.png">
        <span id="selectedAction">Ajouter des fonds</span>
    </div>
    <span>‚ñº</span>
</div>

<div class="optionList" id="actionMenu">
    <div class="optionItem" onclick="selectAction('add')">Ajouter des fonds</div>
    <div class="optionItem" onclick="selectAction('remove')">Retirer des fonds</div>
</div>

<!-- =====================================================
     üí∞ AJOUTER / RETIRER DES FONDS
===================================================== -->
<div class="box">
    <h3 id="fundTitle">üí∞ Ajouter des fonds</h3>

    <input id="dpInput" placeholder="DP ID (ex : DP000001)">
    <input id="amountInput" type="number" placeholder="Montant">

    <button id="fundBtn" onclick="processFunds()">Ajouter</button>
</div>

<!-- =====================================================
     üîç V√©rifier solde
===================================================== -->
<div class="box">
    <h3>üîç V√©rifier un solde</h3>
    <input id="dpCheck" placeholder="DP ID">
    <button onclick="checkBalance()">V√©rifier</button>
    <p id="checkResult" style="margin-top:10px; font-size:18px;"></p>
</div>

<!-- =====================================================
     üëî Ajouter un employ√©
===================================================== -->
<div class="box">
    <h3>üëî Ajouter un employ√©</h3>

    <input id="employeeEmail" placeholder="Email de l'employ√©">

    <select id="employeeType">
        <option value="e1">Employ√© 1</option>
        <option value="e2">Employ√© 2</option>
    </select>

    <button onclick="addEmployee()">Ajouter</button>
</div>

<!-- =====================================================
     ‚ùå SUPPRIMER EMPLOY√â
============================================================ -->
<div class="box">
    <h3 style="color:#ff4444;">‚ùå Supprimer un employ√©</h3>

    <input id="removeEmployeeEmail" placeholder="Email de l'employ√©">

    <button style="background:#ff4444; color:white;" onclick="removeEmployee()">
        Supprimer
    </button>
</div>

<!-- =====================================================
     üì® Demandes de recharge
============================================================ -->
<div class="box">
    <h3>üì® Demandes de recharge</h3>
    <div id="rechargeList"></div>
</div>

<!-- üîµ BOUTON VERIFIER LES DP -->
<button style="background:#005eff; margin-top:20px;"
        onclick="location.href='verifi.html'">
üîç V√©rifier tous les DP
</button>

<!-- BOUTONS EXISTANTS -->
<button style="background:#00eaff; margin-top:20px;" onclick="location.href='Archi.html'">
üìÅ Voir l'historique (Archive)
</button>

<button style="background:red; margin-top:20px;" onclick="location.href='profil.html'">
‚¨ÖÔ∏è Retour au profil
</button>

<!-- NOUVEAU BOUTON OFFON -->
<button style="background:orange; margin-top:20px;" onclick="location.href='offon.html'">
‚ö° Ouvrir OFF/ON
</button>

<!-- üéµ Sons -->
<audio id="soundValidate" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7b8ad29dbb.mp3?filename=correct-2-46134.mp3"></audio>
<audio id="soundRefuse" src="https://cdn.pixabay.com/download/audio/2021/09/09/audio_9d6f5bf86d.mp3?filename=error-126627.mp3"></audio>

<script type="module">
/* ============================================================
   FIREBASE (modular v9)
============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs,
  doc, updateDoc, setDoc, getDoc, writeBatch
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHjL2jDNNbb4P6yIok_GTw8r6FMOyYTiw",
  authDomain: "dpstore-officie.firebaseapp.com",
  projectId: "dpstore-officie",
  storageBucket: "dpstore-officie.firebasestorage.app",
  messagingSenderId: "903943973062",
  appId: "1:903943973062:web:6501a2ec167adb31258fc7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ============================================================
   DROPDOWN UI
============================================================ */
let currentAction = "add";

function toggleMenu(){
    const menu = document.getElementById("actionMenu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

function selectAction(type){
    currentAction = type;

    document.getElementById("selectedAction").innerText =
        type === "add" ? "Ajouter des fonds" : "Retirer des fonds";

    document.getElementById("fundTitle").innerText =
        type === "add" ? "üí∞ Ajouter des fonds" : "üí∏ Retirer des fonds";

    document.getElementById("fundBtn").innerText =
        type === "add" ? "Ajouter" : "Retirer";

    toggleMenu();
}

/* ============================================================
   SESSION (dpstore_user) - utilis√© pour v√©rifier que l'op√©rateur est connect√©
============================================================ */
let sessionUser = null;
try{
    sessionUser = JSON.parse(localStorage.getItem("dpstore_user"));
}catch(e){ sessionUser = null; }

if(!sessionUser || !sessionUser.email){
    alert("Aucune session trouv√©e. Connecte-toi d'abord.");
    location.href = "index.html";
}

/* ============================================================
   HELPERS FIRESTORE
   - findUserByDP(dp) => { id, data } or null
   - findUserByEmail(email) => { id, data } or null
   - refreshSessionFromFirestore()
============================================================ */

async function findUserByDP(dp){
    if(!dp) return null;
    const q = query(collection(db, "users"), where("dp", "==", dp));
    const snaps = await getDocs(q);
    if(snaps.empty) return null;
    const docSnap = snaps.docs[0];
    return { id: docSnap.id, data: docSnap.data() };
}

async function findUserByEmail(email){
    if(!email) return null;
    const normalized = email.trim().toLowerCase();
    const q = query(collection(db, "users"), where("email", "==", normalized));
    const snaps = await getDocs(q);
    if(snaps.empty) return null;
    const docSnap = snaps.docs[0];
    return { id: docSnap.id, data: docSnap.data() };
}

async function refreshSessionFromFirestore(){
    try{
        const r = await findUserByEmail(sessionUser.email);
        if(!r) return;
        // update sessionUser and localStorage
        sessionUser = {
            email: r.data.email,
            username: r.data.username || r.data.email.split("@")[0],
            dp: r.data.dp || "",
            role: r.data.role || "user",
            credits: Number(r.data.credits || 0),
            photo: r.data.photo || null,
            lastLogin: r.data.lastLogin || null
        };
        localStorage.setItem("dpstore_user", JSON.stringify(sessionUser));
    }catch(e){
        console.warn("refreshSessionFromFirestore error:", e);
    }
}

/* ============================================================
   ADD / REMOVE FUNDS (Firestore)
============================================================ */
async function processFunds(){
    const dp = document.getElementById("dpInput").value.trim();
    const amountRaw = document.getElementById("amountInput").value;
    const amount = Number(amountRaw);

    if(dp === "" || !amount || isNaN(amount) || amount <= 0) return alert("‚ö†Ô∏è Champs invalides");

    // find user by DP
    const user = await findUserByDP(dp);
    if(!user) return alert("‚ùå DP introuvable");

    try{
        const userRef = doc(db, "users", user.id);

        // Use updateDoc by reading previous credits to avoid race
        const currentCredits = Number(user.data.credits || 0);
        let newCredits;
        if(currentAction === "add"){
            newCredits = currentCredits + amount;
        } else {
            if(currentCredits < amount) return alert("‚ùå Solde insuffisant!");
            newCredits = currentCredits - amount;
        }

        await updateDoc(userRef, { credits: newCredits, lastActivity: new Date().toISOString() });

        // If operator changed their own account, refresh session
        if((sessionUser.dp || "").toString() === dp) await refreshSessionFromFirestore();

        alert( (currentAction === "add" ? "+" : "-") + amount + " cr√©dits appliqu√©s √† " + dp );
    }catch(e){
        console.error("processFunds error:", e);
        alert("‚ùå Erreur lors de la mise √† jour du solde.");
    }
}

/* ============================================================
   V√©rifier solde (affiche infos depuis Firestore)
============================================================ */
async function checkBalance(){
    const dp = document.getElementById("dpCheck").value.trim();
    if(!dp) return alert("‚ö†Ô∏è Entrez un DP");

    const user = await findUserByDP(dp);
    const resultEl = document.getElementById("checkResult");
    if(!user){
        resultEl.innerHTML = "‚ùå DP introuvable";
        return;
    }

    const d = user.data;
    resultEl.innerHTML = `
        <b>Nom :</b> ${d.username || "Non d√©fini"} <br>
        <b>Email :</b> ${d.email || "Non d√©fini"} <br>
        <b>R√¥le :</b> <span style="color:#00eaff;">${d.role || "user"}</span><br>
        <b>Solde ${dp} :</b> <span style="color:yellow;">${Number(d.credits || 0)} cr√©dits</span>
    `;
}

/* ============================================================
   Ajouter / Retirer un employ√© (Firestore)
   - addEmployee() sets role = "employee" and employeeType field
   - removeEmployee() sets role = "user" and clears employeeType
============================================================ */
async function addEmployee(){
    const emailRaw = document.getElementById("employeeEmail").value.trim();
    const type = document.getElementById("employeeType").value;
    if(!emailRaw) return alert("‚ö†Ô∏è Email vide");

    const found = await findUserByEmail(emailRaw.toLowerCase());
    if(!found) return alert("‚ùå Aucun compte trouv√©");

    try{
        const userRef = doc(db, "users", found.id);
        await updateDoc(userRef, { role: "employee", employeeType: type });
        alert("üëî Employ√© ajout√© !");

        // refresh session if operator updated themself
        if(found.data.email && found.data.email.toLowerCase() === sessionUser.email.toLowerCase()){
            await refreshSessionFromFirestore();
        }
    }catch(e){
        console.error("addEmployee error:", e);
        alert("‚ùå Erreur lors de l'ajout d'employ√©.");
    }
}

async function removeEmployee(){
    const emailRaw = document.getElementById("removeEmployeeEmail").value.trim();
    if(!emailRaw) return alert("‚ö†Ô∏è Email manquant");

    const found = await findUserByEmail(emailRaw.toLowerCase());
    if(!found) return alert("‚ùå Aucun compte trouv√©");

    if((found.data.role || "").toLowerCase() !== "employee") return alert("‚ö†Ô∏è Cet utilisateur n'est pas un employ√©");

    try{
        const userRef = doc(db, "users", found.id);
        await updateDoc(userRef, { role: "user", employeeType: null });
        alert("‚ùå Employ√© retir√© !");
        if(found.data.email && found.data.email.toLowerCase() === sessionUser.email.toLowerCase()){
            await refreshSessionFromFirestore();
        }
    }catch(e){
        console.error("removeEmployee error:", e);
        alert("‚ùå Erreur lors de la suppression d'employ√©.");
    }
}

/* ============================================================
   RECHARGES (localStorage-based as before) + Firestore integration
   - validateRecharge: credit user in Firestore, archive request locally
   - refuseRecharge: mark refused locally & archive
============================================================ */
function loadRecharges(){
    let allKeys = Object.keys(localStorage).filter(k => k.startsWith("dp_recharges_"));
    let globalList = [];

    allKeys.forEach(key => {
        let arr = JSON.parse(localStorage.getItem(key) || "[]" );
        arr.forEach(r => {
            r._storageKey = key;
            globalList.push(r);
        });
    });

    const box = document.getElementById("rechargeList");
    box.innerHTML = "";

    if(globalList.length === 0){
        box.innerHTML = "<p>Aucune demande.</p>";
        return;
    }

    globalList.forEach((r) => {

        box.innerHTML += `
            <div class="request">

                <p><b>${r.name}</b> (${r.email})</p>
                ${r.phone ? `<p>WhatsApp : ${r.phone}</p>` : ""}
                <p><b>DP-ID :</b> ${r.dpID || "Non fourni"}</p>

                <p><b>Montant :</b> 
                    <span style="color:yellow;">${r.amount} HTG</span>
                </p>

                <p><b>Date :</b> ${r.created}</p>

                <p>Status :
                    <span class="status ${r.status}">
                        ${r.status.toUpperCase()}
                    </span>
                </p>

                ${r.receipt ? `<img src="${r.receipt}" alt="Re√ßu">` : ""}

                <div class="btnRow">
                    <button class="btnGreen" onclick="validateRecharge('${r._storageKey.replace(/'/g,"\\'")}', '${r.transcode.replace(/'/g,"\\'")}')">VALIDER</button>
                    <button class="btnRed" onclick="refuseRecharge('${r._storageKey.replace(/'/g,"\\'")}', '${r.transcode.replace(/'/g,"\\'")}')">REFUSER</button>
                </div>
            </div>
        `;
    });
}

function addToArchive(item){
    let arch = JSON.parse(localStorage.getItem("dp_archives") || "[]");
    item.archivedAt = new Date().toLocaleString();
    arch.unshift(item);
    localStorage.setItem("dp_archives", JSON.stringify(arch));
}

async function validateRecharge(storageKey, id){
    let list = JSON.parse(localStorage.getItem(storageKey) || "[]");
    let index = list.findIndex(x => x.transcode === id);
    if(index === -1) return;

    let r = list[index];

    try{
        // credit user in Firestore by DP
        const user = await findUserByDP(r.dpID);
        if(user){
            const userRef = doc(db,"users", user.id);
            const current = Number(user.data.credits || 0);
            const newCredits = current + Number(r.amount || 0);
            await updateDoc(userRef, { credits: newCredits, lastActivity: new Date().toISOString() });

            // If operator updated their own session DP
            if((sessionUser.dp || "") === r.dpID) await refreshSessionFromFirestore();
        }

        r.status = "validated";
        addToArchive(r);
        list.splice(index, 1);
        localStorage.setItem(storageKey, JSON.stringify(list));
        document.getElementById("soundValidate").play();
        loadRecharges();
    }catch(e){
        console.error("validateRecharge error:", e);
        alert("‚ùå Erreur lors de la validation.");
    }
}

function refuseRecharge(storageKey, id){
    let list = JSON.parse(localStorage.getItem(storageKey) || "[]");
    let index = list.findIndex(x => x.transcode === id);
    if(index === -1) return;

    let r = list[index];

    r.status = "refused";
    addToArchive(r);
    list.splice(index, 1);
    localStorage.setItem(storageKey, JSON.stringify(list));
    document.getElementById("soundRefuse").play();
    loadRecharges();
}

/* ============================================================
   INIT
============================================================ */
(async function init(){
    try{
        // refresh session info
        await refreshSessionFromFirestore();
    }catch(e){
        console.warn("init warning:", e);
    }
    loadRecharges();
})();

</script>

</body>
</html>
